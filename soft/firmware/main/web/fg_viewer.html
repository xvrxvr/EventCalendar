<!DOCTYPE html>

<html><title>Просмотр Отпечатков Пальцев</title>

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="styles.css">
<script src="jslib.js"></script>
</head>

<body>

<h1><center>Библиотека Отпечатков Пальцев</center></h1>

<table>
$[HTMLFGLibrary]
<tr><th class="fgl-ptr" onclick="edit_user(this, 1, 'Антон')">Антон<td><div id="u1-0" class="fgl-box fgl-box-filled fgl-ptr" onclick="del_fg(this, 1,0, 'Антон')"></div><td><div id="u1-1" class="fgl-box"></div><td><div id="u1-2" class="fgl-box"></div><td><div id="u1-3" class="fgl-box"></div></tr>
<tr><th>Сергей<td><div id="u2-0" class="fgl-box fgl-box-filled"></div><td><div id="u2-1" class="fgl-box fgl-box-filled"></div><td><div id="u2-2" class="fgl-box  fgl-box-filled"></div><td><div id="u2-3" class="fgl-box fgl-box-filled"></div></tr>
</table>

<div class="fgl-popuptext" id="popup-text" onclick="popup_clicked()"></div>

<!-- <p><button type="button" onclick="test()">Test</button></p> -->

<script>

function highlight(cmds)
{
    for(const cmd of cmds)
    {
        if (cmd.cmd != 'fgview-box-msg') continue;
        const id = `u${cmd.dst}`;
        if ('hlt' in cmd)
        {
            const elem = I(id);
            const old_color = elem.style.backgroundColor;
            elem.style.backgroundColor = `rgb(0, ${Math.round(80+176*cmd.hlt)}, 0)`;
            call_later(cmd, () => {elem.style.backgroundColor = old_color;});
        }
        set_html_with_timeout(cmd, id);
    }
}

function show_popup(parent, msg)
{
    const elem = I("popup-text");
    elem.innerHTML = msg;
    const rect = parent.getBoundingClientRect();
    const p_top = rect.top - 10;
    const p_mid = rect.left + (rect.width >> 1);
    elem.classList.add("fgl-show");
    const float_rect = elem.getBoundingClientRect();
    elem.style.top = `${p_top - float_rect.height}px`;
    let left = p_mid - (float_rect.width >> 1);
    if (left < 0) left = 0;
    elem.style.left = `${left}px`;

    window.onclick = ({target}) => {
        if (target != elem && target != parent) 
        {
            elem.classList.remove("fgl-show");
            window.onclick = null;
            document.onkeydown = null;
        }
    };
    document.onkeydown = () => {
        elem.classList.remove("fgl-show");
        window.onclick = null;
        document.onkeydown = null;
    };
}

let popup_data = null;

function popup_clicked()
{
    const elem = I("popup-text");
    elem.classList.remove("fgl-show");
    window.onclick = null;
    document.onkeydown = null;
    if (popup_data) popup_data();
    popup_data = null;
}

function edit_user(self, user_idx, usr_name)
{
    show_popup(self, `Редактировать отпечатки пользователя '${usr_name}'?`);
    popup_data = () => {
        location.href = '../action/fg_edit.html?index=' + user_idx;
    };
}

function del_fg(self, user_idx, fg_idx, usr_name)
{
    show_popup(self, `Удалить отпечаток №${fg_idx+1} пользователя '${usr_name}'?`);
    popup_data = () => {
        send_del_fg_user(user_idx, fg_idx);
        const elem = I(`u${user_idx}-${fg_idx}`);
        elem.classList.remove("fgl-box-filled");
        elem.onclick = null;
    };
}

set_async_handler(highlight);

/*
function test()
{
    highlight([
        {cmd: 'fgview-box-msg', dst: '2-0', msg: '100%', hlt: 1},
        {cmd: 'fgview-box-msg', dst: '2-1', msg: '80%',  hlt: 0.8},
        {cmd: 'fgview-box-msg', dst: '2-2', msg: '50%',  hlt: 0.5},
        {cmd: 'fgview-box-msg', dst: '2-3', msg: '10%',  hlt: 0.1}
    ]);
}
*/

</script>

</html>
